

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>airtest.core.android.minitouch &mdash; airtest  documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="../../../../genindex.html"/>
        <link rel="search" title="Search" href="../../../../search.html"/>
    <link rel="top" title="airtest  documentation" href="../../../../index.html"/>
        <link rel="up" title="Module code" href="../../../index.html"/> 

  
  <script src="../../../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../../../index.html" class="icon icon-home"> airtest
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../README.html">Airtest</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../all_module/airtest.core.api.html">airtest.core.api module</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../all_module/airtest.core.android.html">airtest.core.android package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../all_module/airtest.core.ios.html">airtest.core.ios package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../all_module/airtest.core.win.html">airtest.core.win package</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../all_module/airtest.html">airtest package</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">airtest</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../../index.html">Module code</a> &raquo;</li>
        
      <li>airtest.core.android.minitouch</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for airtest.core.android.minitouch</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">from</span> <span class="nn">airtest.core.error</span> <span class="k">import</span> <span class="n">MinitouchError</span>
<span class="kn">from</span> <span class="nn">airtest.core.android.constant</span> <span class="k">import</span> <span class="n">STFLIB</span>
<span class="kn">from</span> <span class="nn">airtest.utils.compat</span> <span class="k">import</span> <span class="n">queue</span>
<span class="kn">from</span> <span class="nn">airtest.utils.safesocket</span> <span class="k">import</span> <span class="n">SafeSocket</span>
<span class="kn">from</span> <span class="nn">airtest.utils.nbsp</span> <span class="k">import</span> <span class="n">NonBlockingStreamReader</span>
<span class="kn">from</span> <span class="nn">airtest.utils.snippet</span> <span class="k">import</span> <span class="n">reg_cleanup</span><span class="p">,</span> <span class="n">get_std_encoding</span><span class="p">,</span> <span class="n">on_method_ready</span><span class="p">,</span> <span class="n">ready_method</span>
<span class="kn">from</span> <span class="nn">airtest.utils.logger</span> <span class="k">import</span> <span class="n">get_logger</span>
<span class="n">LOGGING</span> <span class="o">=</span> <span class="n">get_logger</span><span class="p">(</span><span class="s1">&#39;minitouch&#39;</span><span class="p">)</span>


<div class="viewcode-block" id="Minitouch"><a class="viewcode-back" href="../../../../all_module/airtest.core.android.minitouch.html#airtest.core.android.minitouch.Minitouch">[docs]</a><span class="k">class</span> <span class="nc">Minitouch</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Super fast operation from minitouch</span>

<span class="sd">    References:</span>
<span class="sd">    https://github.com/openstf/minitouch</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">adb</span><span class="p">,</span> <span class="n">backend</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">adb</span> <span class="o">=</span> <span class="n">adb</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">backend</span> <span class="o">=</span> <span class="n">backend</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">server_proc</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">display_info</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_y</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
        <span class="n">reg_cleanup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">teardown</span><span class="p">)</span>

<div class="viewcode-block" id="Minitouch.install_and_setup"><a class="viewcode-back" href="../../../../all_module/airtest.core.android.minitouch.html#airtest.core.android.minitouch.Minitouch.install_and_setup">[docs]</a>    <span class="nd">@ready_method</span>
    <span class="k">def</span> <span class="nf">install_and_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Install and setup minitouch</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">install</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">display_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">adb</span><span class="o">.</span><span class="n">display_info</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setup_server</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">backend</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setup_client_backend</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setup_client</span><span class="p">()</span></div>

<div class="viewcode-block" id="Minitouch.uninstall"><a class="viewcode-back" href="../../../../all_module/airtest.core.android.minitouch.html#airtest.core.android.minitouch.Minitouch.uninstall">[docs]</a>    <span class="k">def</span> <span class="nf">uninstall</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Uninstall minitouch</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">adb</span><span class="o">.</span><span class="n">raw_shell</span><span class="p">(</span><span class="s2">&quot;rm /data/local/tmp/minitouch*&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Minitouch.install"><a class="viewcode-back" href="../../../../all_module/airtest.core.android.minitouch.html#airtest.core.android.minitouch.Minitouch.install">[docs]</a>    <span class="k">def</span> <span class="nf">install</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Install minitouch</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">adb</span><span class="o">.</span><span class="n">exists_file</span><span class="p">(</span><span class="s1">&#39;/data/local/tmp/minitouch&#39;</span><span class="p">):</span>
            <span class="n">LOGGING</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;install_minitouch skipped&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">abi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">adb</span><span class="o">.</span><span class="n">getprop</span><span class="p">(</span><span class="s2">&quot;ro.product.cpu.abi&quot;</span><span class="p">)</span>
        <span class="n">sdk</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">adb</span><span class="o">.</span><span class="n">getprop</span><span class="p">(</span><span class="s2">&quot;ro.build.version.sdk&quot;</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">sdk</span> <span class="o">&gt;=</span> <span class="mi">16</span><span class="p">:</span>
            <span class="n">binfile</span> <span class="o">=</span> <span class="s2">&quot;minitouch&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">binfile</span> <span class="o">=</span> <span class="s2">&quot;minitouch-nopie&quot;</span>

        <span class="n">device_dir</span> <span class="o">=</span> <span class="s2">&quot;/data/local/tmp&quot;</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">STFLIB</span><span class="p">,</span> <span class="n">abi</span><span class="p">,</span> <span class="n">binfile</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">adb</span><span class="o">.</span><span class="n">cmd</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;push </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">/minitouch&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">device_dir</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">adb</span><span class="o">.</span><span class="n">shell</span><span class="p">(</span><span class="s2">&quot;chmod 755 </span><span class="si">%s</span><span class="s2">/minitouch&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">device_dir</span><span class="p">))</span>
        <span class="n">LOGGING</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;install_minitouch finished&quot;</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">__transform_xy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Transform coordinates (x, y) according to the device display</span>

<span class="sd">        Args:</span>
<span class="sd">            x: coordinate x</span>
<span class="sd">            y: coordinate y</span>

<span class="sd">        Returns:</span>
<span class="sd">            transformed coordinates (x, y)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">display_info</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_info</span><span class="p">[</span><span class="s1">&#39;max_x&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_info</span><span class="p">[</span><span class="s1">&#39;max_y&#39;</span><span class="p">]):</span>
            <span class="k">return</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span>

        <span class="n">width</span><span class="p">,</span> <span class="n">height</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_info</span><span class="p">[</span><span class="s1">&#39;physical_width&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_info</span><span class="p">[</span><span class="s1">&#39;physical_height&#39;</span><span class="p">]</span>
        <span class="c1"># print &#39;__transform&#39;, x, y</span>
        <span class="c1"># print self.display_info</span>
        <span class="k">if</span> <span class="n">width</span> <span class="o">&gt;</span> <span class="n">height</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_info</span><span class="p">[</span><span class="s1">&#39;orientation&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">]:</span>
            <span class="n">width</span><span class="p">,</span> <span class="n">height</span> <span class="o">=</span> <span class="n">height</span><span class="p">,</span> <span class="n">width</span>

        <span class="n">nx</span> <span class="o">=</span> <span class="n">x</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_x</span> <span class="o">/</span> <span class="n">width</span>
        <span class="n">ny</span> <span class="o">=</span> <span class="n">y</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_y</span> <span class="o">/</span> <span class="n">height</span>
        <span class="k">return</span> <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span>

<div class="viewcode-block" id="Minitouch.setup_server"><a class="viewcode-back" href="../../../../all_module/airtest.core.android.minitouch.html#airtest.core.android.minitouch.Minitouch.setup_server">[docs]</a>    <span class="k">def</span> <span class="nf">setup_server</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Setip minitouch server and adb forward</span>

<span class="sd">        Returns:</span>
<span class="sd">            server process</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">server_proc</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">server_proc</span><span class="o">.</span><span class="n">kill</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">server_proc</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">localport</span><span class="p">,</span> <span class="n">deviceport</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">adb</span><span class="o">.</span><span class="n">setup_forward</span><span class="p">(</span><span class="s2">&quot;localabstract:minitouch_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">)</span>
        <span class="n">deviceport</span> <span class="o">=</span> <span class="n">deviceport</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="s2">&quot;localabstract:&quot;</span><span class="p">):]</span>
        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">adb</span><span class="o">.</span><span class="n">start_shell</span><span class="p">(</span><span class="s2">&quot;/data/local/tmp/minitouch -n &#39;</span><span class="si">%s</span><span class="s2">&#39; 2&gt;&amp;1&quot;</span> <span class="o">%</span> <span class="n">deviceport</span><span class="p">)</span>
        <span class="n">nbsp</span> <span class="o">=</span> <span class="n">NonBlockingStreamReader</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;minitouch_server&quot;</span><span class="p">)</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">nbsp</span><span class="o">.</span><span class="n">readline</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mf">5.0</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;minitouch setup timeout&quot;</span><span class="p">)</span>

            <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">get_std_encoding</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">))</span>

            <span class="c1"># 识别出setup成功的log，并匹配出max_x, max_y</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;Type \w touch device .+ \((\d+)x(\d+) with \d+ contacts\) detected on .+ \(.+\)&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">max_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_y</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)),</span> <span class="nb">int</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
                <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">max_x</span> <span class="o">=</span> <span class="mi">32768</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">max_y</span> <span class="o">=</span> <span class="mi">32768</span>
        <span class="c1"># nbsp.kill() # 保留，不杀了，后面还会继续读取并pirnt</span>
        <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">poll</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># server setup error, may be already setup by others</span>
            <span class="c1"># subprocess exit immediately</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;minitouch server quit immediately&quot;</span><span class="p">)</span>
        <span class="n">reg_cleanup</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">kill</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">server_proc</span> <span class="o">=</span> <span class="n">p</span>
        <span class="k">return</span> <span class="n">p</span></div>

<div class="viewcode-block" id="Minitouch.touch"><a class="viewcode-back" href="../../../../all_module/airtest.core.android.minitouch.html#airtest.core.android.minitouch.Minitouch.touch">[docs]</a>    <span class="nd">@on_method_ready</span><span class="p">(</span><span class="s1">&#39;install_and_setup&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">touch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tuple_xy</span><span class="p">,</span> <span class="n">duration</span><span class="o">=</span><span class="mf">0.01</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform touch event</span>


<span class="sd">        minitouch protocol example::</span>

<span class="sd">            d 0 10 10 50</span>
<span class="sd">            c</span>
<span class="sd">            &lt;wait in your own code&gt;</span>
<span class="sd">            u 0</span>
<span class="sd">            c</span>

<span class="sd">        Args:</span>
<span class="sd">            tuple_xy: coordinates (x, y)</span>
<span class="sd">            duration: time interval for touch event, default is 0.01</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">tuple_xy</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__transform_xy</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">handle</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;d 0 </span><span class="si">%d</span><span class="s2"> </span><span class="si">%d</span><span class="s2"> 50</span><span class="se">\n</span><span class="s2">c</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">duration</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">handle</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;u 0</span><span class="se">\n</span><span class="s2">c</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Minitouch.swipe"><a class="viewcode-back" href="../../../../all_module/airtest.core.android.minitouch.html#airtest.core.android.minitouch.Minitouch.swipe">[docs]</a>    <span class="nd">@on_method_ready</span><span class="p">(</span><span class="s1">&#39;install_and_setup&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">swipe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tuple_from_xy</span><span class="p">,</span> <span class="n">tuple_to_xy</span><span class="p">,</span> <span class="n">duration</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">steps</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform swipe event</span>

<span class="sd">        minitouch protocol example::</span>

<span class="sd">            d 0 0 0 50</span>
<span class="sd">            c</span>
<span class="sd">            m 0 20 0 50</span>
<span class="sd">            c</span>
<span class="sd">            m 0 40 0 50</span>
<span class="sd">            c</span>
<span class="sd">            m 0 60 0 50</span>
<span class="sd">            c</span>
<span class="sd">            m 0 80 0 50</span>
<span class="sd">            c</span>
<span class="sd">            m 0 100 0 50</span>
<span class="sd">            c</span>
<span class="sd">            u 0</span>
<span class="sd">            c</span>

<span class="sd">        Args:</span>
<span class="sd">            tuple_from_xy: start point</span>
<span class="sd">            tuple_to_xy: end point</span>
<span class="sd">            duration: time interval for swipe duration, default is 0.8</span>
<span class="sd">            steps: size of swipe step, default is 5</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">from_x</span><span class="p">,</span> <span class="n">from_y</span> <span class="o">=</span> <span class="n">tuple_from_xy</span>
        <span class="n">to_x</span><span class="p">,</span> <span class="n">to_y</span> <span class="o">=</span> <span class="n">tuple_to_xy</span>

        <span class="n">from_x</span><span class="p">,</span> <span class="n">from_y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__transform_xy</span><span class="p">(</span><span class="n">from_x</span><span class="p">,</span> <span class="n">from_y</span><span class="p">)</span>
        <span class="n">to_x</span><span class="p">,</span> <span class="n">to_y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__transform_xy</span><span class="p">(</span><span class="n">to_x</span><span class="p">,</span> <span class="n">to_y</span><span class="p">)</span>

        <span class="n">interval</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">duration</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">steps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">handle</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;d 0 </span><span class="si">%d</span><span class="s2"> </span><span class="si">%d</span><span class="s2"> 50</span><span class="se">\n</span><span class="s2">c</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">from_x</span><span class="p">,</span> <span class="n">from_y</span><span class="p">))</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">interval</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">steps</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">handle</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;m 0 </span><span class="si">%d</span><span class="s2"> </span><span class="si">%d</span><span class="s2"> 50</span><span class="se">\n</span><span class="s2">c</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">from_x</span> <span class="o">+</span> <span class="p">(</span><span class="n">to_x</span> <span class="o">-</span> <span class="n">from_x</span><span class="p">)</span> <span class="o">*</span> <span class="n">i</span> <span class="o">/</span> <span class="n">steps</span><span class="p">,</span>
                <span class="n">from_y</span> <span class="o">+</span> <span class="p">(</span><span class="n">to_y</span> <span class="o">-</span> <span class="n">from_y</span><span class="p">)</span> <span class="o">*</span> <span class="n">i</span> <span class="o">/</span> <span class="n">steps</span><span class="p">,</span>
            <span class="p">))</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">interval</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">handle</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;m 0 </span><span class="si">%d</span><span class="s2"> </span><span class="si">%d</span><span class="s2"> 50</span><span class="se">\n</span><span class="s2">c</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">to_x</span><span class="p">,</span> <span class="n">to_y</span><span class="p">))</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">interval</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">handle</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;u 0</span><span class="se">\n</span><span class="s2">c</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Minitouch.pinch"><a class="viewcode-back" href="../../../../all_module/airtest.core.android.minitouch.html#airtest.core.android.minitouch.Minitouch.pinch">[docs]</a>    <span class="nd">@on_method_ready</span><span class="p">(</span><span class="s1">&#39;install_and_setup&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">pinch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">percent</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">duration</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">steps</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">in_or_out</span><span class="o">=</span><span class="s1">&#39;in&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform pinch action</span>

<span class="sd">        minitouch protocol example::</span>

<span class="sd">            d 0 0 100 50</span>
<span class="sd">            d 1 100 0 50</span>
<span class="sd">            c</span>
<span class="sd">            m 0 10 90 50</span>
<span class="sd">            m 1 90 10 50</span>
<span class="sd">            c</span>
<span class="sd">            m 0 20 80 50</span>
<span class="sd">            m 1 80 20 50</span>
<span class="sd">            c</span>
<span class="sd">            m 0 20 80 50</span>
<span class="sd">            m 1 80 20 50</span>
<span class="sd">            c</span>
<span class="sd">            m 0 30 70 50</span>
<span class="sd">            m 1 70 30 50</span>
<span class="sd">            c</span>
<span class="sd">            m 0 40 60 50</span>
<span class="sd">            m 1 60 40 50</span>
<span class="sd">            c</span>
<span class="sd">            m 0 50 50 50</span>
<span class="sd">            m 1 50 50 50</span>
<span class="sd">            c</span>
<span class="sd">            u 0</span>
<span class="sd">            u 1</span>
<span class="sd">            c</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_info</span><span class="p">[</span><span class="s1">&#39;width&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_info</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">center</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
            <span class="n">x0</span><span class="p">,</span> <span class="n">y0</span> <span class="o">=</span> <span class="n">center</span>
        <span class="k">elif</span> <span class="n">center</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">x0</span><span class="p">,</span> <span class="n">y0</span> <span class="o">=</span> <span class="n">w</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">h</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;center should be None or list/tuple, not </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span><span class="n">center</span><span class="p">))</span>

        <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span> <span class="o">=</span> <span class="n">x0</span> <span class="o">-</span> <span class="n">w</span> <span class="o">*</span> <span class="n">percent</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">y0</span> <span class="o">-</span> <span class="n">h</span> <span class="o">*</span> <span class="n">percent</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span> <span class="o">=</span> <span class="n">x0</span> <span class="o">+</span> <span class="n">w</span> <span class="o">*</span> <span class="n">percent</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">y0</span> <span class="o">+</span> <span class="n">h</span> <span class="o">*</span> <span class="n">percent</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">cmds</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">in_or_out</span> <span class="o">==</span> <span class="s1">&#39;in&#39;</span><span class="p">:</span>
            <span class="n">cmds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;d 0 </span><span class="si">%d</span><span class="s2"> </span><span class="si">%d</span><span class="s2"> 50</span><span class="se">\n</span><span class="s2">d 1 </span><span class="si">%d</span><span class="s2"> </span><span class="si">%d</span><span class="s2"> 50</span><span class="se">\n</span><span class="s2">c</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">steps</span><span class="p">):</span>
                <span class="n">cmds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;m 0 </span><span class="si">%d</span><span class="s2"> </span><span class="si">%d</span><span class="s2"> 50</span><span class="se">\n</span><span class="s2">m 1 </span><span class="si">%d</span><span class="s2"> </span><span class="si">%d</span><span class="s2"> 50</span><span class="se">\n</span><span class="s2">c</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">x1</span><span class="o">+</span><span class="p">(</span><span class="n">x0</span><span class="o">-</span><span class="n">x1</span><span class="p">)</span><span class="o">*</span><span class="n">i</span><span class="o">/</span><span class="n">steps</span><span class="p">,</span> <span class="n">y1</span><span class="o">+</span><span class="p">(</span><span class="n">y0</span><span class="o">-</span><span class="n">y1</span><span class="p">)</span><span class="o">*</span><span class="n">i</span><span class="o">/</span><span class="n">steps</span><span class="p">,</span>
                    <span class="n">x2</span><span class="o">+</span><span class="p">(</span><span class="n">x0</span><span class="o">-</span><span class="n">x2</span><span class="p">)</span><span class="o">*</span><span class="n">i</span><span class="o">/</span><span class="n">steps</span><span class="p">,</span> <span class="n">y2</span><span class="o">+</span><span class="p">(</span><span class="n">y0</span><span class="o">-</span><span class="n">y2</span><span class="p">)</span><span class="o">*</span><span class="n">i</span><span class="o">/</span><span class="n">steps</span>
                <span class="p">))</span>
            <span class="n">cmds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;m 0 </span><span class="si">%d</span><span class="s2"> </span><span class="si">%d</span><span class="s2"> 50</span><span class="se">\n</span><span class="s2">m 1 </span><span class="si">%d</span><span class="s2"> </span><span class="si">%d</span><span class="s2"> 50</span><span class="se">\n</span><span class="s2">c</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">))</span>
            <span class="n">cmds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;u 0</span><span class="se">\n</span><span class="s2">u 1</span><span class="se">\n</span><span class="s2">c</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">in_or_out</span> <span class="o">==</span> <span class="s1">&#39;out&#39;</span><span class="p">:</span>
            <span class="n">cmds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;d 0 </span><span class="si">%d</span><span class="s2"> </span><span class="si">%d</span><span class="s2"> 50</span><span class="se">\n</span><span class="s2">d 1 </span><span class="si">%d</span><span class="s2"> </span><span class="si">%d</span><span class="s2"> 50</span><span class="se">\n</span><span class="s2">c</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">steps</span><span class="p">):</span>
                <span class="n">cmds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;m 0 </span><span class="si">%d</span><span class="s2"> </span><span class="si">%d</span><span class="s2"> 50</span><span class="se">\n</span><span class="s2">m 1 </span><span class="si">%d</span><span class="s2"> </span><span class="si">%d</span><span class="s2"> 50</span><span class="se">\n</span><span class="s2">c</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">x0</span><span class="o">+</span><span class="p">(</span><span class="n">x1</span><span class="o">-</span><span class="n">x0</span><span class="p">)</span><span class="o">*</span><span class="n">i</span><span class="o">/</span><span class="n">steps</span><span class="p">,</span> <span class="n">y0</span><span class="o">+</span><span class="p">(</span><span class="n">y1</span><span class="o">-</span><span class="n">y0</span><span class="p">)</span><span class="o">*</span><span class="n">i</span><span class="o">/</span><span class="n">steps</span><span class="p">,</span>
                    <span class="n">x0</span><span class="o">+</span><span class="p">(</span><span class="n">x2</span><span class="o">-</span><span class="n">x0</span><span class="p">)</span><span class="o">*</span><span class="n">i</span><span class="o">/</span><span class="n">steps</span><span class="p">,</span> <span class="n">y0</span><span class="o">+</span><span class="p">(</span><span class="n">y2</span><span class="o">-</span><span class="n">y0</span><span class="p">)</span><span class="o">*</span><span class="n">i</span><span class="o">/</span><span class="n">steps</span>
                <span class="p">))</span>
            <span class="n">cmds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;m 0 </span><span class="si">%d</span><span class="s2"> </span><span class="si">%d</span><span class="s2"> 50</span><span class="se">\n</span><span class="s2">m 1 </span><span class="si">%d</span><span class="s2"> </span><span class="si">%d</span><span class="s2"> 50</span><span class="se">\n</span><span class="s2">c</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">))</span>
            <span class="n">cmds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;u 0</span><span class="se">\n</span><span class="s2">u 1</span><span class="se">\n</span><span class="s2">c</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;center should be &#39;in&#39; or &#39;out&#39;, not </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span><span class="n">in_or_out</span><span class="p">))</span>

        <span class="n">interval</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">duration</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">steps</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cmds</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">handle</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">interval</span><span class="p">)</span></div>

<div class="viewcode-block" id="Minitouch.operate"><a class="viewcode-back" href="../../../../all_module/airtest.core.android.minitouch.html#airtest.core.android.minitouch.Minitouch.operate">[docs]</a>    <span class="nd">@on_method_ready</span><span class="p">(</span><span class="s1">&#39;install_and_setup&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">operate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform down, up and move actions</span>

<span class="sd">        Args:</span>
<span class="sd">            args: action arguments, dictionary containing type and x, y coordinates, e.g.::</span>

<span class="sd">                  {</span>
<span class="sd">                  &quot;type&quot; : &quot;down&quot;,</span>
<span class="sd">                  &quot;x&quot; : 10,</span>
<span class="sd">                  &quot;y&quot; : 10</span>
<span class="sd">                  }</span>

<span class="sd">        Raises:</span>
<span class="sd">            RuntimeError: is invalid arguments are provided</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;down&quot;</span><span class="p">:</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__transform_xy</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">],</span> <span class="n">args</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">])</span>
            <span class="c1"># support py 3</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;d 0 </span><span class="si">%d</span><span class="s2"> </span><span class="si">%d</span><span class="s2"> 50</span><span class="se">\n</span><span class="s2">c</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">args</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;move&quot;</span><span class="p">:</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__transform_xy</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">],</span> <span class="n">args</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">])</span>
            <span class="c1"># support py 3</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;m 0 </span><span class="si">%d</span><span class="s2"> </span><span class="si">%d</span><span class="s2"> 50</span><span class="se">\n</span><span class="s2">c</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">args</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;up&quot;</span><span class="p">:</span>
            <span class="c1"># support py 3</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;u 0</span><span class="se">\n</span><span class="s2">c</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;invalid operate args: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">args</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">handle</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span></div>

<div class="viewcode-block" id="Minitouch.safe_send"><a class="viewcode-back" href="../../../../all_module/airtest.core.android.minitouch.html#airtest.core.android.minitouch.Minitouch.safe_send">[docs]</a>    <span class="k">def</span> <span class="nf">safe_send</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Send data to client</span>

<span class="sd">        Args:</span>
<span class="sd">            data: data to send</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception: when data cannot be sent</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="c1"># raise MinitouchError(err)</span>
            <span class="k">raise</span> <span class="n">err</span></div>

    <span class="k">def</span> <span class="nf">_backend_worker</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Backend worker queue thread</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">backend_stop_event</span><span class="o">.</span><span class="n">isSet</span><span class="p">():</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">backend_queue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">safe_send</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>

<div class="viewcode-block" id="Minitouch.setup_client_backend"><a class="viewcode-back" href="../../../../all_module/airtest.core.android.minitouch.html#airtest.core.android.minitouch.Minitouch.setup_client_backend">[docs]</a>    <span class="k">def</span> <span class="nf">setup_client_backend</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Setup backend client thread as daemon</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">backend_queue</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">backend_stop_event</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setup_client</span><span class="p">()</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_backend_worker</span><span class="p">)</span>
        <span class="n">t</span><span class="o">.</span><span class="n">daemon</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">t</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">backend_thread</span> <span class="o">=</span> <span class="n">t</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">handle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">backend_queue</span><span class="o">.</span><span class="n">put</span></div>

<div class="viewcode-block" id="Minitouch.setup_client"><a class="viewcode-back" href="../../../../all_module/airtest.core.android.minitouch.html#airtest.core.android.minitouch.Minitouch.setup_client">[docs]</a>    <span class="k">def</span> <span class="nf">setup_client</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Setup client in following steps::</span>

<span class="sd">            1. connect to server</span>
<span class="sd">            2. receive the header</span>
<span class="sd">                v &lt;version&gt;</span>
<span class="sd">                ^ &lt;max-contacts&gt; &lt;max-x&gt; &lt;max-y&gt; &lt;max-pressure&gt;</span>
<span class="sd">                $ &lt;pid&gt;</span>
<span class="sd">            3. prepare to send</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">SafeSocket</span><span class="p">()</span>
        <span class="n">s</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">adb</span><span class="o">.</span><span class="n">host</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">localport</span><span class="p">))</span>
        <span class="n">s</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">settimeout</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">header</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">header</span> <span class="o">+=</span> <span class="n">s</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">4096</span><span class="p">)</span>  <span class="c1"># size is not strict, so use raw socket.recv</span>
            <span class="k">except</span> <span class="n">socket</span><span class="o">.</span><span class="n">timeout</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;minitouch setup client error&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">header</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="n">LOGGING</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;minitouch header:</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">header</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client</span> <span class="o">=</span> <span class="n">s</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">handle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">safe_send</span></div>

<div class="viewcode-block" id="Minitouch.teardown"><a class="viewcode-back" href="../../../../all_module/airtest.core.android.minitouch.html#airtest.core.android.minitouch.Minitouch.teardown">[docs]</a>    <span class="k">def</span> <span class="nf">teardown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Stop the server and client</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;backend_stop_event&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">backend_stop_event</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">server_proc</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">server_proc</span><span class="o">.</span><span class="n">kill</span><span class="p">()</span></div></div>
</pre></div>

           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017, Game-Netease.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../../../',
            VERSION:'',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../../../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../../../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>