

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>airtest.aircv.smart_crop &mdash; airtest  documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="../../../genindex.html"/>
        <link rel="search" title="Search" href="../../../search.html"/>
    <link rel="top" title="airtest  documentation" href="../../../index.html"/>
        <link rel="up" title="Module code" href="../../index.html"/> 

  
  <script src="../../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../../index.html" class="icon icon-home"> airtest
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../README.html">Airtest</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../README.html#features">Features</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../README.html#install">Install</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../README.html#use-as-a-python-package">Use as a python package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../README.html#use-with-airtest-ide">Use with Airtest IDE</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../README.html#use-with-command-line">Use with command line</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../all_module/airtest.core.api.html">airtest.core.api module</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../all_module/airtest.core.android.html">airtest.core.android package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../all_module/airtest.core.ios.html">airtest.core.ios package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../all_module/airtest.core.win.html">airtest.core.win package</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../all_module/airtest.html">airtest package</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">airtest</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>airtest.aircv.smart_crop</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for airtest.aircv.smart_crop</h1><div class="highlight"><pre>
<span></span><span class="c1"># coding=utf-8</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    本文件用于智能monkey，自动检测画面中可点击的控件：</span>
<span class="sd">    控件分类：</span>
<span class="sd">        1、文字按键类型（商城-背包-聊天框）</span>
<span class="sd">        2、完整轮廓（比如按钮-图标-人物头像）</span>
<span class="sd">        3、特殊角点（箭头）</span>
<span class="sd">    方法1：</span>
<span class="sd">        integral_preprocess(gray_img):</span>
<span class="sd">            Laplacian → 二值化 → 膨胀-膨胀 → 提取轮廓 → 轮廓筛选</span>
<span class="sd">            适用于UI界面的主要控件提取，细节提取较为不足。</span>
<span class="sd">    方法2：</span>
<span class="sd">        detail_detect(img):</span>
<span class="sd">            sobel → 二值化 → 膨胀-腐蚀-膨胀 → 提取轮廓 → 轮廓筛选</span>
<span class="sd">            默认使用Sobel预处理：适用于各种界面，细节完备，但是提取点太多。</span>
<span class="sd">&#39;&#39;&#39;</span>

<span class="kn">import</span> <span class="nn">cv2</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="c1"># 默认截图长宽</span>
<span class="n">MIN_WIDTH</span> <span class="o">=</span> <span class="mi">20</span>
<span class="n">MAX_WIDTH</span> <span class="o">=</span> <span class="mi">100</span>
<span class="c1"># 选择边缘检测方法：0: Laplacian  1：Sobel_x  2：Sobel_y  3: Sobel_x_y  4:Canny</span>
<span class="c1"># Laplacian整体性好，Sobel细节好， Canny效果较差</span>
<span class="n">CONTOUR_METHOD</span> <span class="o">=</span> <span class="mi">1</span>
<span class="c1"># 膨胀、腐蚀、膨胀的算子</span>
<span class="n">KERNEL</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">)]</span>
<span class="c1"># 膨胀、腐蚀算子</span>
<span class="n">DILATE_KERNEL_1</span> <span class="o">=</span> <span class="n">KERNEL</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># (24, 6)    (10, 8)</span>
<span class="n">EROSION_KERNEL</span> <span class="o">=</span> <span class="n">KERNEL</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>   <span class="c1"># (30, 9)   (20, 8)</span>
<span class="n">DILATE_KERNEL_2</span> <span class="o">=</span> <span class="n">KERNEL</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>   <span class="c1"># (30, 9)   (20, 8)</span>

<span class="c1"># MIN_AREA = 600 # 筛选掉选中区域面积小的</span>
<span class="n">MIN_AREA</span> <span class="o">=</span> <span class="mi">400</span>   <span class="c1"># 筛选掉选中区域面积小的</span>
<span class="c1"># 显示结果，存储处理过程图像</span>
<span class="n">STORE_CACHE</span> <span class="o">=</span> <span class="kc">False</span>


<div class="viewcode-block" id="integral_preprocess"><a class="viewcode-back" href="../../../all_module/airtest.aircv.smart_crop.html#airtest.aircv.smart_crop.integral_preprocess">[docs]</a><span class="k">def</span> <span class="nf">integral_preprocess</span><span class="p">(</span><span class="n">gray_img</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        预处理方法1： Laplacian → 二值化 → 膨胀-膨胀 → 提取</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">contour_result</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">Laplacian</span><span class="p">(</span><span class="n">gray_img</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">CV_8U</span><span class="p">)</span>
    <span class="n">ret</span><span class="p">,</span> <span class="n">binary</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">threshold</span><span class="p">(</span>
        <span class="n">contour_result</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">THRESH_OTSU</span> <span class="o">+</span> <span class="n">cv2</span><span class="o">.</span><span class="n">THRESH_BINARY</span><span class="p">)</span>
    <span class="n">dilate_element1</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">getStructuringElement</span><span class="p">(</span>
        <span class="n">cv2</span><span class="o">.</span><span class="n">MORPH_RECT</span><span class="p">,</span> <span class="n">DILATE_KERNEL_1</span><span class="p">)</span>
    <span class="n">dilation</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">dilate</span><span class="p">(</span><span class="n">binary</span><span class="p">,</span> <span class="n">dilate_element1</span><span class="p">,</span> <span class="n">iterations</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">dilation2</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">dilate</span><span class="p">(</span><span class="n">dilation</span><span class="p">,</span> <span class="n">dilate_element1</span><span class="p">,</span> <span class="n">iterations</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">dilation2</span></div>


<div class="viewcode-block" id="preprocess"><a class="viewcode-back" href="../../../all_module/airtest.aircv.smart_crop.html#airtest.aircv.smart_crop.preprocess">[docs]</a><span class="k">def</span> <span class="nf">preprocess</span><span class="p">(</span><span class="n">gray_img</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        预处理方法2： Sobel(默认) → 二值化 → 膨胀-膨胀 → 提取</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c1"># 1、求出边缘提取结果：</span>
    <span class="k">if</span> <span class="n">CONTOUR_METHOD</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># &#39;&#39;&#39;使用laplacian边缘检测算法，细节易丢失&#39;&#39;&#39;</span>
        <span class="n">contour_result</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">Laplacian</span><span class="p">(</span><span class="n">gray_img</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">CV_8U</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">CONTOUR_METHOD</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="c1"># &#39;&#39;&#39;使用sobel算子进行边缘检测（默认使用x方向）&#39;&#39;&#39;</span>
        <span class="n">contour_result</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">Sobel</span><span class="p">(</span><span class="n">gray_img</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">CV_8U</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ksize</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">CONTOUR_METHOD</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="c1"># &#39;&#39;&#39;使用sobel算子进行边缘检测（默认使用y方向）&#39;&#39;&#39;</span>
        <span class="n">contour_result</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">Sobel</span><span class="p">(</span><span class="n">gray_img</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">CV_8U</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ksize</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">CONTOUR_METHOD</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="c1"># &#39;&#39;&#39;使用sobel算子进行边缘检测（默认使用x_y方向）&#39;&#39;&#39;</span>
        <span class="n">contour_result</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">Sobel</span><span class="p">(</span><span class="n">gray_img</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">CV_8U</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ksize</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">CONTOUR_METHOD</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
        <span class="c1"># &#39;&#39;&#39;使用canny边缘检测算法，实现初始的边缘检测.&#39;&#39;&#39;</span>
        <span class="n">threshold_one</span><span class="p">,</span> <span class="n">threshold_two</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span>          <span class="c1"># threshold_one, threshold_two = 100, 200</span>
        <span class="n">blur</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">GaussianBlur</span><span class="p">(</span><span class="n">gray_img</span><span class="p">,</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>   <span class="c1"># 高斯模糊，减少噪点</span>
        <span class="n">contour_result</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">Canny</span><span class="p">(</span><span class="n">blur</span><span class="p">,</span> <span class="n">threshold_one</span><span class="p">,</span> <span class="n">threshold_two</span><span class="p">)</span>      <span class="c1"># 检测边缘</span>
    <span class="c1"># 2. 二值化</span>
    <span class="n">ret</span><span class="p">,</span> <span class="n">binary</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">threshold</span><span class="p">(</span>
        <span class="n">contour_result</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">THRESH_OTSU</span> <span class="o">+</span> <span class="n">cv2</span><span class="o">.</span><span class="n">THRESH_BINARY</span><span class="p">)</span>
    <span class="c1"># 3. 膨胀和腐蚀操作的核函数</span>
    <span class="n">dilate_element1</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">getStructuringElement</span><span class="p">(</span>
        <span class="n">cv2</span><span class="o">.</span><span class="n">MORPH_RECT</span><span class="p">,</span> <span class="n">DILATE_KERNEL_1</span><span class="p">)</span>   <span class="c1"># 膨胀1的核函数</span>
    <span class="n">erosion_element</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">getStructuringElement</span><span class="p">(</span>
        <span class="n">cv2</span><span class="o">.</span><span class="n">MORPH_RECT</span><span class="p">,</span> <span class="n">EROSION_KERNEL</span><span class="p">)</span>    <span class="c1"># 腐蚀的核函数</span>
    <span class="n">dilate_element2</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">getStructuringElement</span><span class="p">(</span>
        <span class="n">cv2</span><span class="o">.</span><span class="n">MORPH_RECT</span><span class="p">,</span> <span class="n">DILATE_KERNEL_2</span><span class="p">)</span>   <span class="c1"># 膨胀2的核函数</span>
    <span class="c1"># 4. 膨胀一次，让轮廓突出</span>
    <span class="n">dilation</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">dilate</span><span class="p">(</span><span class="n">binary</span><span class="p">,</span> <span class="n">dilate_element1</span><span class="p">,</span> <span class="n">iterations</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1"># 5. 腐蚀一次，去掉线状物细节。注意这里去掉的是竖直的线（因为sobel算子使用x向的边缘提取）</span>
    <span class="n">erosion</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">erode</span><span class="p">(</span><span class="n">dilation</span><span class="p">,</span> <span class="n">erosion_element</span><span class="p">,</span> <span class="n">iterations</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1"># 6. 再次膨胀，让轮廓明显一些</span>
    <span class="n">dilation2</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">dilate</span><span class="p">(</span><span class="n">erosion</span><span class="p">,</span> <span class="n">dilate_element2</span><span class="p">,</span> <span class="n">iterations</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>  <span class="c1"># 膨胀2的核函数</span>

    <span class="c1"># 存储中间图片</span>
    <span class="k">if</span> <span class="n">STORE_CACHE</span><span class="p">:</span>
        <span class="n">cv2</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="s2">&quot;binary.png&quot;</span><span class="p">,</span> <span class="n">binary</span><span class="p">)</span>
        <span class="n">cv2</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="s2">&quot;dilation.png&quot;</span><span class="p">,</span> <span class="n">dilation</span><span class="p">)</span>
        <span class="n">cv2</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="s2">&quot;erosion.png&quot;</span><span class="p">,</span> <span class="n">erosion</span><span class="p">)</span>
        <span class="n">cv2</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="s2">&quot;dilation2.png&quot;</span><span class="p">,</span> <span class="n">dilation2</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">dilation2</span></div>


<div class="viewcode-block" id="smart_target_crop"><a class="viewcode-back" href="../../../all_module/airtest.aircv.smart_crop.html#airtest.aircv.smart_crop.smart_target_crop">[docs]</a><span class="k">def</span> <span class="nf">smart_target_crop</span><span class="p">(</span><span class="n">img_rgb</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">point</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">max_width</span><span class="o">=</span><span class="n">MAX_WIDTH</span><span class="p">,</span> <span class="n">min_width</span><span class="o">=</span><span class="n">MIN_WIDTH</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        完整性提取（使用Laplacian预处理），适用于web-app、UI界面等。</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">img_rgb</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;image to crop is NULL !&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">point</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;no target point to smart_crop the image !&quot;</span><span class="p">)</span>
    <span class="c1"># 1.  转化成灰度图</span>
    <span class="n">gray_img</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">img_rgb</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2GRAY</span><span class="p">)</span>
    <span class="c1"># 2. 形态学变换的预处理，得到可以查找矩形的图片</span>
    <span class="k">if</span> <span class="n">detail</span><span class="p">:</span>
        <span class="n">dilation</span> <span class="o">=</span> <span class="n">preprocess</span><span class="p">(</span><span class="n">gray_img</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">dilation</span> <span class="o">=</span> <span class="n">integral_preprocess</span><span class="p">(</span><span class="n">gray_img</span><span class="p">)</span>
    <span class="c1"># 3. 查找和筛选轮廓</span>
    <span class="n">region</span> <span class="o">=</span> <span class="n">get_proper_contour</span><span class="p">(</span><span class="n">dilation</span><span class="p">)</span>

    <span class="n">target_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># 根据边缘提取结果，找到point所在的矩形备选区域target_list</span>
    <span class="k">for</span> <span class="n">rect_xywh</span> <span class="ow">in</span> <span class="n">region</span><span class="p">:</span>
        <span class="n">dis</span> <span class="o">=</span> <span class="p">[</span><span class="n">point</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">rect_xywh</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">point</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">rect_xywh</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
        <span class="k">if</span> <span class="n">dis</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">dis</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">rect_xywh</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="ow">and</span> <span class="n">dis</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">dis</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">rect_xywh</span><span class="p">[</span><span class="mi">3</span><span class="p">]:</span>
            <span class="n">target_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rect_xywh</span><span class="p">)</span>

    <span class="c1"># 尝试从备选区域列表target_list中，找出目标区域（面积最小的那个）</span>
    <span class="n">final_xywh</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">target_list</span><span class="p">:</span>
        <span class="n">target</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">target_list</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">target</span> <span class="o">=</span> <span class="n">target_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">target_list</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
            <span class="n">is_the_one</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">for</span> <span class="n">rect</span> <span class="ow">in</span> <span class="n">target_list</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">target</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">rect</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="n">is_the_one</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">is_the_one</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">target</span><span class="p">:</span>
            <span class="c1"># 初步筛选得到的target区域宽、高均大于最低图像宽度时，才认定为有效结果：</span>
            <span class="k">if</span> <span class="n">target</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">min_width</span> <span class="ow">and</span> <span class="n">target</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">min_width</span><span class="p">:</span>
                <span class="n">final_xywh</span> <span class="o">=</span> <span class="n">target</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># 如果的找到了合适包含区域，那么就结合最大截图区域进行修形</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">max_width</span>
    <span class="k">if</span> <span class="n">final_xywh</span><span class="p">:</span>
        <span class="c1"># 只要目标区域final_xywh的宽/高大于100时，才需要修形：(区域边缘距离点击位置不要超过50)</span>
        <span class="k">if</span> <span class="n">final_xywh</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">w</span> <span class="ow">or</span> <span class="n">final_xywh</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">w</span><span class="p">:</span>
            <span class="n">left_margin</span><span class="p">,</span> <span class="n">top_margin</span> <span class="o">=</span> <span class="n">point</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">final_xywh</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">point</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">final_xywh</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">right_margin</span><span class="p">,</span> <span class="n">bot_margin</span> <span class="o">=</span> <span class="n">final_xywh</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">left_margin</span><span class="p">,</span> <span class="n">final_xywh</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">top_margin</span>
            <span class="n">left_margin</span><span class="p">,</span> <span class="n">top_margin</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">left_margin</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">w</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)),</span> <span class="nb">min</span><span class="p">(</span><span class="n">top_margin</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">w</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span>
            <span class="n">right_margin</span><span class="p">,</span> <span class="n">bot_margin</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">right_margin</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">w</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)),</span> <span class="nb">min</span><span class="p">(</span><span class="n">bot_margin</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">w</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span>
            <span class="n">final_xywh</span> <span class="o">=</span> <span class="p">[</span><span class="n">point</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">left_margin</span><span class="p">,</span> <span class="n">point</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">top_margin</span><span class="p">,</span> <span class="n">left_margin</span> <span class="o">+</span> <span class="n">right_margin</span><span class="p">,</span> <span class="n">top_margin</span> <span class="o">+</span> <span class="n">bot_margin</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># 如果发现没有合适的包含区域，直接按照100*100进行截图：</span>
        <span class="n">final_xywh</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">point</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">w</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">point</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">w</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span> <span class="n">w</span><span class="p">,</span> <span class="n">w</span><span class="p">]</span>

    <span class="n">target_img</span> <span class="o">=</span> <span class="n">crop_by_xywh</span><span class="p">(</span><span class="n">img_rgb</span><span class="p">,</span> <span class="n">final_xywh</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">target_img</span></div>


<div class="viewcode-block" id="crop_by_xywh"><a class="viewcode-back" href="../../../all_module/airtest.aircv.smart_crop.html#airtest.aircv.smart_crop.crop_by_xywh">[docs]</a><span class="k">def</span> <span class="nf">crop_by_xywh</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">rect</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Crop image, rect = [x_min, y_min, w ,h]</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">img</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">NoneImageError</span><span class="p">(</span><span class="s2">&quot;Image to crop is None !&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">height</span><span class="p">,</span> <span class="n">width</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
        <span class="c1"># 获取在图像中的实际有效区域：</span>
        <span class="n">x_min</span><span class="p">,</span> <span class="n">y_min</span><span class="p">,</span> <span class="n">x_max</span><span class="p">,</span> <span class="n">y_max</span> <span class="o">=</span> <span class="n">rect</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">rect</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">rect</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">rect</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">rect</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">rect</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">x_min</span><span class="p">,</span> <span class="n">y_min</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">x_min</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">y_min</span><span class="p">)</span>
        <span class="n">x_min</span><span class="p">,</span> <span class="n">y_min</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">width</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">x_min</span><span class="p">),</span> <span class="nb">min</span><span class="p">(</span><span class="n">height</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">y_min</span><span class="p">)</span>
        <span class="n">x_max</span><span class="p">,</span> <span class="n">y_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">x_max</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">y_max</span><span class="p">)</span>
        <span class="n">x_max</span><span class="p">,</span> <span class="n">y_max</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">width</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">x_max</span><span class="p">),</span> <span class="nb">min</span><span class="p">(</span><span class="n">height</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">y_max</span><span class="p">)</span>

        <span class="c1"># 返回剪切的有效图像：(必须保证截图时的变量为整型)</span>
        <span class="n">img_crop</span> <span class="o">=</span> <span class="n">img</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">y_min</span><span class="p">):</span><span class="nb">int</span><span class="p">(</span><span class="n">y_max</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">x_min</span><span class="p">):</span><span class="nb">int</span><span class="p">(</span><span class="n">x_max</span><span class="p">)]</span>
        <span class="k">return</span> <span class="n">img_crop</span></div>


<div class="viewcode-block" id="get_proper_contour"><a class="viewcode-back" href="../../../all_module/airtest.aircv.smart_crop.html#airtest.aircv.smart_crop.get_proper_contour">[docs]</a><span class="k">def</span> <span class="nf">get_proper_contour</span><span class="p">(</span><span class="n">img</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        轮廓提取：</span>
<span class="sd">            获取轮廓后：1、去除面积过小的轮廓； 2、去除比例过于细长的轮廓.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">region</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># 1. 查找轮廓 OpenCV 3.0 使用方法：</span>
    <span class="n">contours</span><span class="p">,</span> <span class="n">hierarchy</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">findContours</span><span class="p">(</span>
        <span class="n">img</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">RETR_TREE</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">CHAIN_APPROX_SIMPLE</span><span class="p">)[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span>
    <span class="c1"># 2. 轮廓筛选：</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">contours</span><span class="p">)):</span>
        <span class="n">cnt</span> <span class="o">=</span> <span class="n">contours</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="c1"># 计算该轮廓的面积</span>
        <span class="n">area</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">contourArea</span><span class="p">(</span><span class="n">cnt</span><span class="p">)</span>
        <span class="c1"># 面积小的都筛选掉</span>
        <span class="k">if</span><span class="p">(</span><span class="n">area</span> <span class="o">&lt;</span> <span class="n">MIN_AREA</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="c1"># 截图时，轮廓都是水平矩形：</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">boundingRect</span><span class="p">(</span><span class="n">cnt</span><span class="p">)</span>
        <span class="c1"># 计算欧式距离，作为实际矩形的宽和高：</span>
        <span class="n">height</span><span class="p">,</span> <span class="n">width</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">),</span> <span class="nb">min</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">)</span>
        <span class="c1"># 筛选那些太细长的矩形</span>
        <span class="k">if</span><span class="p">(</span><span class="n">height</span> <span class="o">&gt;</span> <span class="n">width</span> <span class="o">*</span> <span class="mi">3</span> <span class="ow">and</span> <span class="n">width</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="k">elif</span><span class="p">(</span><span class="n">height</span> <span class="o">&gt;</span> <span class="n">width</span> <span class="o">*</span> <span class="mi">10</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="c1"># 把计算得到的有效面积也加入进来</span>
        <span class="n">region</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">area</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">region</span></div>
</pre></div>

           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017, Game-Netease.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../../',
            VERSION:'',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>